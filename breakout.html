<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Breakout</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      canvas {
        background: #eee;
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <canvas id="myCanvas" width="480" height="320"></canvas>

    <script src="mecha.js"></script>
    <script>
var game = new Game("myCanvas");
game.registerKey("ArrowRight");
game.registerKey("ArrowLeft");
game.initKeyListeners();

var ball = game.createEntity();
ball.add(new Transform(game.width / 2, game.height - 30, 3, -3));
ball.add(new AABB(20, 20));
ball.add(new BallShape("#0095DD"));

var paddle = game.createEntity();
paddle.add(new Transform(game.width / 2, game.height - 5));
paddle.add(new AABB(75, 10));
paddle.add(new BoxShape("#0095DD"));

var bricks = [];
var brickRows = 5;
var brickCols = 3;
for(var i = 0; i < brickRows; i++) {
    bricks.push([]);
    for(var j = 0; j < brickCols; j++) {
        var brick = game.createEntity(); 
        brick.add(new Transform(i*85 + 70, j*30 + 50));
        brick.add(new AABB(75, 20));
        brick.add(new BoxShape("#0095DD"));
        bricks[i].push(brick);
    }
}

var score = 0;
var lives = 3;
var outcome = 0;

var scoreCounter = game.createEntity();
scoreCounter.add(new Transform(55, 28));
scoreCounter.add(new TextDisplay("#0095DD", "16px Arial", "Score: "+score));

var livesCounter = game.createEntity();
livesCounter.add(new Transform(game.width - 53, 28));
livesCounter.add(new TextDisplay("#0095DD", "16px Arial", "Lives: "+lives));

function update_logic() {
    for(var i = 0; i < brickRows; i++) {
        for(var j = 0; j < brickCols; j++) {
            var brick = bricks[i][j];
            if (!brick.has('aabb')) continue;
            if (ball.get('aabb').intersects(brick.get('aabb'))) {
                ball.get('transform').vy *= -1;
                brick.remove('aabb');
                brick.remove('boxshape');
                score++;
                scoreCounter.get("textdisplay").text = "Score: "+score;

                if(score == brickRows*brickCols) {
                    outcome = 1;
                }

                return; // so that it doesn't collide with two in the same frame
            }
        }
    }

    var p = paddle.get('aabb');
    var b = ball.get('aabb');
    var vx = ball.get('transform').vx;
    var vy = ball.get('transform').vy;

    if (b.x + b.w + vx > game.width || b.x + vx < 0) {
        ball.get('transform').vx *= -1;
    }
    if (b.y + vy < 0) {
        ball.get('transform').vy *= -1;
    }
    if (b.y + b.h + vy > p.y) {
        if (b.x + vx + b.w/2 > p.x && b.x + vx - b.w/2 < p.x + p.w) {
            ball.get('transform').vy *= -1;
        } else if (!outcome) {
            lives--;
            livesCounter.get("textdisplay").text = "Lives: "+lives;
            
            if(!lives) {
                outcome = -1;
            } else {
                ball.get('transform').cx = game.width / 2;
                ball.get('transform').cy = game.height - 30;
                ball.get('transform').vx = Math.abs(vx) + 0.5;
                ball.get('transform').vy = -(Math.abs(vy) + 0.5);
                paddle.get('transform').cx = game.width / 2;
            }
        }
    }

    if (!outcome) {
        if (game.keyState['ArrowRight'] && p.x + p.w < game.width) {
            paddle.get('transform').cx += 7;
        } else if (game.keyState['ArrowLeft'] && p.x > 0) {
            paddle.get('transform').cx -= 7;
        }
    } else {
        ball.get("transform").vx = 0;
        ball.get("transform").vy = 0;
    }
}

//function mouseMoveHandler(e) {
//  var relativeX = e.clientX - canvas.offsetLeft;
//  if(relativeX > 0 && relativeX < canvas.width) {
//    paddleX = relativeX - paddleWidth/2;
//  }
//}

game.run(update_logic);
    </script>
  </body>
</html>