<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Simple Breakout Game</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      canvas {
        background: #eee;
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <canvas id="myCanvas" width="480" height="320"></canvas>

    <script src="mecha.js"></script>
    <script>
  
var game = new Game("myCanvas")
var score = 0;
var lives = 3;
var outcome = 0;

var ball = new Entity(game);
ball.add(new Transform(game.width / 2, game.height - 30, 3, -3));
ball.add(new AABB(20, 20));
ball.add(new BallShape("#0095DD"));

var paddle = new Entity(game);
paddle.add(new Transform(game.width / 2, game.height - 5));
paddle.add(new AABB(75, 10));
paddle.add(new BoxShape("#0095DD"));

var bricks = [];
var brickRows = 5;
var brickCols = 3;
for(var i = 0; i < brickRows; i++) {
    bricks.push([]);
    for(var j = 0; j < brickCols; j++) {
        var brick = new Entity(game); 
        brick.add(new Transform(i*85 + 70, j*30 + 50));
        brick.add(new AABB(75, 20));
        brick.add(new BoxShape("#0095DD"));
        bricks[i].push(brick);
    }
}

game.registerKey("ArrowRight");
game.registerKey("ArrowLeft");
game.initKeyListeners();

//function mouseMoveHandler(e) {
//  var relativeX = e.clientX - canvas.offsetLeft;
//  if(relativeX > 0 && relativeX < canvas.width) {
//    paddleX = relativeX - paddleWidth/2;
//  }
//}
function collisionDetection() {
    for(var i = 0; i < brickRows; i++) {
        for(var j = 0; j < brickCols; j++) {
            var brick = bricks[i][j];
            if (!brick.has('aabb')) continue;
            if (ball.get('aabb').intersects(brick.get('aabb'))) {
                ball.get('transform').vy *= -1;
                brick.remove('aabb');
                brick.remove('boxshape');
                score++;

                if(score == brickRows*brickCols) {
                    outcome = 1;
                }

                return; // so that it doesn't collide with two in the same frame
            }
        }
    }
}

function draw() {
    game.clear();
    for(var i = 0; i < brickRows; i++) {
        for(var j = 0; j < brickCols; j++) {
            bricks[i][j].draw();
        }
    }
    ball.draw();
    paddle.draw();

    game.write("#0095DD", "16px Arial", 8, 20, "Score: "+score);
    game.write("#0095DD", "16px Arial", game.width-65, 20, "Lives: "+lives);
    collisionDetection();

    var p = paddle.get('aabb');
    var b = ball.get('aabb');
    vx = ball.get('transform').vx;
    vy = ball.get('transform').vy;

    if (b.x + b.w + vx > game.width || b.x + vx < 0) {
        ball.get('transform').vx *= -1;
    }
    if (b.y + vy < 0) {
        ball.get('transform').vy *= -1;
    }
    if (b.y + b.h + vy > p.y) {
        if (b.x + vx + b.w/2 > p.x && b.x + vx - b.w/2 < p.x + p.w) {
            ball.get('transform').vy *= -1;
        } else if (!outcome) {
            lives--;
            if(!lives) {
                outcome = -1;
            } else {
                ball.get('transform').cx = game.width / 2;
                ball.get('transform').cy = game.height - 30;
                ball.get('transform').vx = Math.abs(vx) + 0.5;
                ball.get('transform').vy = -(Math.abs(vy) + 0.5);
                paddle.get('transform').cx = game.width / 2;
            }
        }
    }

    if (!outcome) {
        if (game.keyState['ArrowRight'] && p.x + p.w < game.width) {
            paddle.get('transform').cx += 7;
        } else if (game.keyState['ArrowLeft'] && p.x > 0) {
            paddle.get('transform').cx -= 7;
        }
    }

    if (!outcome) ball.update();
    requestAnimationFrame(draw);
}

draw();
    </script>
  </body>
</html>